<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chia Tiền Chi Tiêu (Đồng Bộ & Kiểm Soát Người Tham Gia)</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        h2 {
            color: #007bff;
            text-align: center;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }
        th {
            background-color: #007bff;
            color: white;
            font-weight: bold;
        }
        td:nth-child(1) {
            text-align: left;
            font-weight: bold;
        }
        .contribution-total {
            font-size: 1.1em;
            font-weight: bold;
            color: #28a745;
        }
        .add-expense-cell {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        .add-expense-cell input[type="number"] {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: right;
            width: 60px;
        }
        .add-button {
            padding: 8px 12px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .add-button:hover {
            background-color: #1e7e34;
        }
        .summary {
            margin-top: 20px;
            padding: 15px;
            background-color: #e9f7ff;
            border-radius: 6px;
            border-left: 5px solid #007bff;
        }
        .positive {
            color: #28a745; /* Được nhận (dư) */
            font-weight: bold;
        }
        .negative {
            color: #dc3545; /* Phải trả (nợ) */
            font-weight: bold;
        }
        .neutral {
            color: #6c757d; /* Cân bằng */
            font-weight: bold;
        }
        .reset-button {
            margin-top: 15px;
            padding: 10px 15px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            width: 100%;
        }
        .reset-button:hover {
            background-color: #c82333;
        }
        /* Style cho Checkbox */
        #attendanceControl {
            margin-bottom: 20px; 
            text-align: center; 
            border: 1px dashed #007bff; 
            padding: 10px; 
            border-radius: 5px;
            background-color: #f0f8ff;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>Nhập Tiền Vào Để Tính</h2>
    
    <div id="attendanceControl">
        <label for="isFiveMembers">
            <input type="checkbox" id="isFiveMembers" onchange="calculateAndUpdate()" checked> 
            Tuần này **Tất cả 5 AE** đều ăn. (Bỏ tích nếu có người vắng, chỉ chia 4)
        </label>
    </div>
    <div class="summary">
        <p><strong>Tổng Chi Tiêu:</strong> <span id="totalSpent">0 VNĐ</span></p>
        <p><strong>Mức Chia Đều:</strong> <span id="fairShare">0 VNĐ</span></p>
    </div>

    <table>
        <thead>
            <tr>
                <th>Tên</th>
                <th>Tiền Đóng</th>
                <th>Nhập tiền vào</th>
                <th>Sau Tính Toán</th>
            </tr>
        </thead>
        <tbody id="contributionTableBody">
            </tbody>
    </table>
    
    <button class="reset-button" onclick="resetContributions()">Xóa tất cả dữ liệu đã nhập</button>
</div>

<script>
    // --- KHỞI TẠO FIREBASE (Sử dụng cấu hình của bạn) ---
    const firebaseConfig = {
        apiKey: "AIzaSyAmoKeG8CUMldomehgVG_hGA8Gn7mb2iwA",
        authDomain: "chia-tien-57805.firebaseapp.com",
        databaseURL: "https://chia-tien-57805-default-rtdb.firebaseio.com",
        projectId: "chia-tien-57805",
        storageBucket: "chia-tien-57805.firebasestorage.app",
        messagingSenderId: "204223753606",
        appId: "1:204223753606:web:516c63a18a9d0894779007",
        measurementId: "G-EC2WNHLXF0"
    };
    
    firebase.initializeApp(firebaseConfig);
    const dbRef = firebase.database().ref('contributions'); 

    // 1. Cấu trúc dữ liệu cố định
    const MEMBER_NAMES = ["Duy", "Vanh", "Sơn", "Heo Pepi", "Trung"];
    let contributions = {
        "Duy": 0,
        "Vanh": 0,
        "Sơn": 0,
        "Heo Pepi": 0,
        "Trung": 0,
    };
    
    let isFiveMembers = true; // Biến kiểm soát trạng thái checkbox
    const K_UNIT = 1000;

    // --- CÁC HÀM TIỆN ÍCH ---

    function formatCurrency(amount) {
        // Nếu số âm, sign là '-' (đã sửa lỗi dấu trừ)
        const sign = amount < 0 ? '-' : ''; 
        
        const absAmount = Math.abs(amount / K_UNIT);
        const formatted = new Intl.NumberFormat('vi-VN').format(Math.round(absAmount));
        
        // Trả về "+0k" nếu gần 0 để chỉ sự cân bằng
        if (Math.abs(amount) < 10) { 
            return '+0k';
        }

        return `${sign}${formatted}k`; 
    }
    
    function formatTotal(amount) {
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(Math.round(amount));
    }
    
    function formatContributionTotal(amount) {
        return `${new Intl.NumberFormat('vi-VN').format(Math.round(amount / K_UNIT))}k`;
    }

    // --- CÁC HÀM XỬ LÝ LƯU TRỮ (FIREBASE) ---

    function saveContributions() {
        // Lưu cả contributions và trạng thái checkbox
        const dataToSave = {
            contributions: contributions,
            isFiveMembers: isFiveMembers 
        };
        
        dbRef.set(dataToSave)
            .then(() => {
                console.log("Dữ liệu và trạng thái checkbox đã được lưu.");
            })
            .catch((error) => {
                console.error("Lỗi khi lưu dữ liệu lên Firebase: ", error);
            });
    }

    function loadContributions() {
        dbRef.once('value', (snapshot) => {
            if (snapshot.exists()) {
                const loadedData = snapshot.val();
                
                // 1. Tải contributions
                const loadedContributions = loadedData.contributions || {};
                MEMBER_NAMES.forEach(name => {
                    contributions[name] = loadedContributions[name] || 0;
                });
                
                // 2. Tải trạng thái checkbox
                isFiveMembers = loadedData.isFiveMembers !== undefined ? loadedData.isFiveMembers : true;
                
                // Cập nhật giao diện checkbox
                const checkboxElement = document.getElementById('isFiveMembers');
                if (checkboxElement) {
                    checkboxElement.checked = isFiveMembers;
                }

            } else {
                saveContributions(); // Lưu cấu trúc mặc định nếu chưa có dữ liệu
            }
            
            renderTable();
        }, (error) => {
            console.error("Lỗi khi tải dữ liệu từ Firebase: ", error);
            renderTable(); 
        });
    }

    // --- LOGIC TÍNH TOÁN VÀ CẬP NHẬT ---

    function calculateAndUpdate() {
        // Đọc trạng thái mới nhất của checkbox
        const checkboxElement = document.getElementById('isFiveMembers');
        isFiveMembers = checkboxElement ? checkboxElement.checked : true;
        
        // 1. Xác định số lượng người chia (N)
        const N_Total = MEMBER_NAMES.length; // Luôn là 5
        const N = isFiveMembers ? N_Total : N_Total - 1; // Chia 5 nếu tích, chia 4 nếu bỏ tích
        
        // 2. Tính Tổng Chi tiêu
        let totalSpent = 0;
        for (const name in contributions) {
            totalSpent += contributions[name];
            
            const totalElement = document.getElementById(`total-${name.replace(/\s/g, '-')}`);
            if (totalElement) {
                totalElement.textContent = formatContributionTotal(contributions[name]);
            }
        }

        // 3. Tính Mức Chia Đều (Fair Share)
        const fairShare = N > 0 ? totalSpent / N : 0;
        
        // 4. Cập nhật bảng tổng kết
        document.getElementById('totalSpent').textContent = formatTotal(totalSpent);
        document.getElementById('fairShare').textContent = formatTotal(fairShare);

        // 5. Tính Số Dư Cuối Cùng và cập nhật từng dòng
        MEMBER_NAMES.forEach(name => {
            const balance = contributions[name] - fairShare;
            const balanceElement = document.getElementById(`balance-${name.replace(/\s/g, '-')}`);
            
            if (balanceElement) {
                balanceElement.className = 'balance-status';
                
                if (totalSpent > 0 && balance > 10) { 
                    balanceElement.classList.add('positive'); 
                    balanceElement.textContent = formatCurrency(balance);
                } else if (totalSpent > 0 && balance < -10) { 
                    balanceElement.classList.add('negative'); 
                    balanceElement.textContent = formatCurrency(balance); // Có dấu trừ
                } else {
                    balanceElement.classList.add('neutral'); 
                    balanceElement.textContent = '+0k'; 
                }
            }
        });
        
        saveContributions(); 
    }
    
    // --- CÁC HÀM XỬ LÝ TƯƠNG TÁC (Giữ nguyên) ---

    function addContribution(name) {
        const inputElement = document.getElementById(`input-${name.replace(/\s/g, '-')}`);
        const amount = parseFloat(inputElement.value) * K_UNIT || 0;
        
        if (amount > 0) {
            contributions[name] += amount;
            inputElement.value = '';
            calculateAndUpdate();
        } else if (amount < 0) {
             alert("Vui lòng nhập số tiền chi tiêu dương.");
             inputElement.value = '';
        }
    }

    // --- CÁC HÀM XỬ LÝ GIAO DIỆN VÀ KHỞI TẠO ---

    function renderTable() {
        const tbody = document.getElementById('contributionTableBody');
        tbody.innerHTML = '';
        
        MEMBER_NAMES.forEach(name => {
            const row = document.createElement('tr');
            const safeName = name.replace(/\s/g, '-'); 
            
            row.innerHTML = `
                <td>${name}</td>
                <td>
                    <span class="contribution-total" id="total-${safeName}">${formatContributionTotal(contributions[name])}</span>
                </td>
                <td>
                    <div class="add-expense-cell">
                        <input 
                            type="number" 
                            min="0" 
                            id="input-${safeName}"
                            placeholder="Số k"
                            onkeypress="if(event.key === 'Enter') { addContribution('${name}'); }"
                        >
                        <button class="add-button" onclick="addContribution('${name}')">Thêm</button>
                    </div>
                </td>
                <td>
                    <span id="balance-${safeName}" class="balance-status neutral">+0k</span>
                </td>
            `;
            tbody.appendChild(row);
        });
        
        calculateAndUpdate(); 
    }
    
    function resetContributions() {
        if (confirm("Bạn có chắc chắn muốn xóa tất cả số tiền đã đóng góp không? Dữ liệu sẽ bị xóa khỏi tất cả thiết bị.")) {
            MEMBER_NAMES.forEach(name => {
                contributions[name] = 0;
                const inputElement = document.getElementById(`input-${name.replace(/\s/g, '-')}`);
                if (inputElement) {
                    inputElement.value = '';
                }
            });
            
            // Reset trạng thái checkbox về mặc định (có ăn)
            isFiveMembers = true; 
            const checkboxElement = document.getElementById('isFiveMembers');
            if (checkboxElement) {
                checkboxElement.checked = true;
            }

            // Ghi lại object rỗng/mặc định lên Firebase
            dbRef.set({
                contributions: contributions,
                isFiveMembers: isFiveMembers
            })
                .then(() => {
                    console.log("Dữ liệu đã được xóa khỏi Firebase.");
                    calculateAndUpdate();
                })
                .catch((error) => {
                    console.error("Lỗi khi xóa dữ liệu Firebase: ", error);
                    alert("Lỗi: Không thể xóa dữ liệu trên Firebase.");
                });
        }
    }

    // Khởi tạo: Tải dữ liệu từ Firebase khi trang được tải
    document.addEventListener('DOMContentLoaded', loadContributions);
</script>
</body>
</html>
