<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chia Tiền Chi Tiêu (Tùy Chọn Từng Người)</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        h2 {
            color: #007bff;
            text-align: center;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }
        th {
            background-color: #007bff;
            color: white;
            font-weight: bold;
        }
        td:nth-child(2) { /* Cột Tên (Name) */
            text-align: left;
            font-weight: bold;
        }
        .contribution-total {
            font-size: 1.1em;
            font-weight: bold;
            color: #28a745;
        }
        .add-expense-cell {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        .add-expense-cell input[type="number"] {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: right;
            width: 60px;
        }
        .add-button {
            padding: 8px 12px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .add-button:hover {
            background-color: #1e7e34;
        }
        .summary {
            margin-top: 20px;
            padding: 15px;
            background-color: #e9f7ff;
            border-radius: 6px;
            border-left: 5px solid #007bff;
        }
        .positive {
            color: #28a745;
            font-weight: bold;
        }
        .negative {
            color: #dc3545;
            font-weight: bold;
        }
        .neutral {
            color: #6c757d;
            font-weight: bold;
        }
        .reset-button {
            margin-top: 15px;
            padding: 10px 15px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            width: 100%;
        }
        .reset-button:hover {
            background-color: #c82333;
        }
        /* Style cho Checkbox tham gia */
        .participation-checkbox {
            transform: scale(1.5); /* Phóng to checkbox */
        }
    </style>
</head>
<body>

<div class="container">
    <h2>Nhập Tiền Vào Để Tính</h2>
    
    <div class="summary">
        <p><strong>Tổng Chi Tiêu:</strong> <span id="totalSpent">0 VNĐ</span></p>
        <p><strong>Mức Chia Đều:</strong> <span id="fairShare">0 VNĐ</span></p>
    </div>

    <table>
        <thead>
            <tr>
                <th>Tham gia</th> <th>Tên</th>
                <th>Tiền Đóng</th>
                <th>Nhập tiền vào</th>
                <th>Sau Tính Toán</th>
            </tr>
        </thead>
        <tbody id="contributionTableBody">
            </tbody>
    </table>
    
    <button class="reset-button" onclick="resetContributions()">Xóa tất cả dữ liệu đã nhập</button>
</div>

<script>
    // --- KHỞI TẠO FIREBASE (Sử dụng cấu hình của bạn) ---
    const firebaseConfig = {
        apiKey: "AIzaSyAmoKeG8CUMldomehgVG_hGA8Gn7mb2iwA",
        authDomain: "chia-tien-57805.firebaseapp.com",
        databaseURL: "https://chia-tien-57805-default-rtdb.firebaseio.com",
        projectId: "chia-tien-57805",
        storageBucket: "chia-tien-57805.firebasestorage.app",
        messagingSenderId: "204223753606",
        appId: "1:204223753606:web:516c63a18a9d0894779007",
        measurementId: "G-EC2WNHLXF0"
    };
    
    firebase.initializeApp(firebaseConfig);
    const dbRef = firebase.database().ref('contributions'); 

    // 1. Cấu trúc dữ liệu cố định
    const MEMBER_NAMES = ["Duy", "Vanh", "Sơn", "Heo Pepi", "Trung"];
    let contributions = {
        "Duy": 0,
        "Vanh": 0,
        "Sơn": 0,
        "Heo Pepi": 0,
        "Trung": 0,
    };
    
    // ĐỐI TƯỢNG MỚI: Theo dõi trạng thái tham gia của từng người
    let participation = {
        "Duy": true,
        "Vanh": true,
        "Sơn": true,
        "Heo Pepi": true,
        "Trung": true,
    };

    const K_UNIT = 1000;

    // --- CÁC HÀM TIỆN ÍCH ---

    function formatCurrency(amount) {
        const sign = amount < 0 ? '-' : ''; 
        const absAmount = Math.abs(amount / K_UNIT);
        const formatted = new Intl.NumberFormat('vi-VN').format(Math.round(absAmount));
        
        if (Math.abs(amount) < 10) { 
            return '+0k';
        }
        return `${sign}${formatted}k`; 
    }
    
    function formatTotal(amount) {
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(Math.round(amount));
    }
    
    function formatContributionTotal(amount) {
        return `${new Intl.NumberFormat('vi-VN').format(Math.round(amount / K_UNIT))}k`;
    }

    // --- CÁC HÀM XỬ LÝ LƯU TRỮ (FIREBASE) ---

    function saveContributions() {
        // Lưu cả contributions và trạng thái tham gia (participation)
        const dataToSave = {
            contributions: contributions,
            participation: participation 
        };
        
        dbRef.set(dataToSave); // Không cần then/catch chi tiết ở đây, chỉ cần đảm bảo lưu
    }

    function loadContributions() {
        dbRef.once('value', (snapshot) => {
            if (snapshot.exists()) {
                const loadedData = snapshot.val();
                
                // 1. Tải contributions
                const loadedContributions = loadedData.contributions || {};
                MEMBER_NAMES.forEach(name => {
                    contributions[name] = loadedContributions[name] || 0;
                });
                
                // 2. Tải trạng thái tham gia
                const loadedParticipation = loadedData.participation || {};
                MEMBER_NAMES.forEach(name => {
                    participation[name] = loadedParticipation[name] !== undefined ? loadedParticipation[name] : true;
                });

            } else {
                saveContributions(); // Lưu cấu trúc mặc định nếu chưa có dữ liệu
            }
            
            renderTable();
        }, (error) => {
            console.error("Lỗi khi tải dữ liệu từ Firebase: ", error);
            renderTable(); 
        });
    }

    // --- LOGIC TÍNH TOÁN VÀ CẬP NHẬT ---

    function calculateAndUpdate() {
        // 1. Tính số lượng người tham gia thực tế (N)
        let N = 0;
        MEMBER_NAMES.forEach(name => {
            if (participation[name]) {
                N++;
            }
        });

        // 2. Tính Tổng Chi tiêu
        let totalSpent = 0;
        for (const name in contributions) {
            totalSpent += contributions[name];
            
            const totalElement = document.getElementById(`total-${name.replace(/\s/g, '-')}`);
            if (totalElement) {
                totalElement.textContent = formatContributionTotal(contributions[name]);
            }
        }

        // 3. Tính Mức Chia Đều (Fair Share)
        const fairShare = N > 0 ? totalSpent / N : 0;
        
        // 4. Cập nhật bảng tổng kết
        document.getElementById('totalSpent').textContent = formatTotal(totalSpent);
        document.getElementById('fairShare').textContent = formatTotal(fairShare);

        // 5. Tính Số Dư Cuối Cùng và cập nhật từng dòng
        MEMBER_NAMES.forEach(name => {
            const balanceElement = document.getElementById(`balance-${name.replace(/\s/g, '-')}`);
            
            if (balanceElement) {
                balanceElement.className = 'balance-status';
                
                // Chỉ tính toán số dư nếu người đó CÓ THAM GIA
                if (participation[name]) {
                    const balance = contributions[name] - fairShare;

                    if (totalSpent > 0 && balance > 10) { 
                        balanceElement.classList.add('positive'); 
                        balanceElement.textContent = formatCurrency(balance);
                    } else if (totalSpent > 0 && balance < -10) { 
                        balanceElement.classList.add('negative'); 
                        balanceElement.textContent = formatCurrency(balance);
                    } else {
                        balanceElement.classList.add('neutral'); 
                        balanceElement.textContent = '+0k'; 
                    }
                } else {
                    // Nếu không tham gia, số dư luôn là 0 (hoặc tiền đã đóng góp)
                    balanceElement.classList.add('neutral'); 
                    balanceElement.textContent = formatContributionTotal(contributions[name]); // Hiện tiền đã đóng nếu có
                    if (contributions[name] === 0) {
                        balanceElement.textContent = '-'; // Hoặc dấu gạch ngang nếu không có tiền đóng
                    }
                }
            }
        });
        
        saveContributions(); 
    }
    
    // --- HÀM XỬ LÝ SỰ KIỆN THAY ĐỔI CHECKBOX MỚI ---
    function toggleParticipation(name) {
        const checkbox = document.getElementById(`participate-${name.replace(/\s/g, '-')}`);
        participation[name] = checkbox.checked; // Cập nhật trạng thái
        calculateAndUpdate(); // Tính toán lại
    }

    // --- CÁC HÀM XỬ LÝ TƯƠNG TÁC (Thêm tiền) ---

    function addContribution(name) {
        const inputElement = document.getElementById(`input-${name.replace(/\s/g, '-')}`);
        const amount = parseFloat(inputElement.value) * K_UNIT || 0;
        
        if (amount > 0) {
            contributions[name] += amount;
            inputElement.value = '';
            calculateAndUpdate();
        } else if (amount < 0) {
             alert("Vui lòng nhập số tiền chi tiêu dương.");
             inputElement.value = '';
        }
    }

    // --- CÁC HÀM XỬ LÝ GIAO DIỆN VÀ KHỞI TẠO ---

    function renderTable() {
        const tbody = document.getElementById('contributionTableBody');
        tbody.innerHTML = '';
        
        MEMBER_NAMES.forEach(name => {
            const row = document.createElement('tr');
            const safeName = name.replace(/\s/g, '-'); 
            
            // Xây dựng hàng với CỘT CHECKBOX MỚI
            row.innerHTML = `
                <td>
                    <input 
                        type="checkbox" 
                        class="participation-checkbox"
                        id="participate-${safeName}" 
                        ${participation[name] ? 'checked' : ''}
                        onchange="toggleParticipation('${name}')"
                    >
                </td>
                <td>${name}</td>
                <td>
                    <span class="contribution-total" id="total-${safeName}">${formatContributionTotal(contributions[name])}</span>
                </td>
                <td>
                    <div class="add-expense-cell">
                        <input 
                            type="number" 
                            min="0" 
                            id="input-${safeName}"
                            placeholder="Số k"
                            onkeypress="if(event.key === 'Enter') { addContribution('${name}'); }"
                        >
                        <button class="add-button" onclick="addContribution('${name}')">Thêm</button>
                    </div>
                </td>
                <td>
                    <span id="balance-${safeName}" class="balance-status neutral">+0k</span>
                </td>
            `;
            tbody.appendChild(row);
        });
        
        calculateAndUpdate(); 
    }
    
    function resetContributions() {
        if (confirm("Bạn có chắc chắn muốn xóa tất cả số tiền đã đóng góp không? Dữ liệu sẽ bị xóa khỏi tất cả thiết bị.")) {
            MEMBER_NAMES.forEach(name => {
                contributions[name] = 0;
                participation[name] = true; // Reset trạng thái tham gia
                const inputElement = document.getElementById(`input-${name.replace(/\s/g, '-')}`);
                if (inputElement) {
                    inputElement.value = '';
                }
            });
            
            // Ghi lại object rỗng/mặc định lên Firebase
            dbRef.set({
                contributions: contributions,
                participation: participation
            })
                .then(() => {
                    console.log("Dữ liệu đã được xóa khỏi Firebase.");
                    renderTable(); // Vẽ lại bảng để cập nhật trạng thái tham gia
                })
                .catch((error) => {
                    console.error("Lỗi khi xóa dữ liệu Firebase: ", error);
                    alert("Lỗi: Không thể xóa dữ liệu trên Firebase.");
                });
        }
    }

    // Khởi tạo: Tải dữ liệu từ Firebase khi trang được tải
    document.addEventListener('DOMContentLoaded', loadContributions);
</script>
</body>
</html>
