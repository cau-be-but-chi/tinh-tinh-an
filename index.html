<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chia Tiền Chi Tiêu (Đồng Bộ)</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        h2 {
            color: #007bff;
            text-align: center;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }
        th {
            background-color: #007bff;
            color: white;
            font-weight: bold;
        }
        td:nth-child(1) {
            text-align: left;
            font-weight: bold;
        }
        .contribution-total {
            font-size: 1.1em;
            font-weight: bold;
            color: #28a745;
        }
        .add-expense-cell {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        .add-expense-cell input[type="number"] {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: right;
            width: 60px;
        }
        .add-button {
            padding: 8px 12px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .add-button:hover {
            background-color: #1e7e34;
        }
        .summary {
            margin-top: 20px;
            padding: 15px;
            background-color: #e9f7ff;
            border-radius: 6px;
            border-left: 5px solid #007bff;
        }
        .positive {
            color: #28a745; /* Được nhận (dư) */
            font-weight: bold;
        }
        .negative {
            color: #dc3545; /* Phải trả (nợ) */
            font-weight: bold;
        }
        .neutral {
            color: #6c757d; /* Cân bằng */
            font-weight: bold;
        }
        .reset-button {
            margin-top: 15px;
            padding: 10px 15px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            width: 100%;
        }
        .reset-button:hover {
            background-color: #c82333;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>Nhập Tiền Vào Để Tính</h2>
    
    <div class="summary">
        <p><strong>Tổng Chi Tiêu:</strong> <span id="totalSpent">0 VNĐ</span></p>
        <p><strong>Mức Chia Đều:</strong> <span id="fairShare">0 VNĐ</span></p>
    </div>

    <table>
        <thead>
            <tr>
                <th>Tên</th>
                <th>Tiền Đóng</th>
                <th>Nhập tiền vào</th>
                <th>Sau Tính Toán</th>
            </tr>
        </thead>
        <tbody id="contributionTableBody">
            </tbody>
    </table>
    
    <button class="reset-button" onclick="resetContributions()">Xóa tất cả dữ liệu đã nhập</button>
</div>

<script>
    // --- KHỞI TẠO FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyAmoKeG8CUMldomehgVG_hGA8Gn7mb2iwA",
        authDomain: "chia-tien-57805.firebaseapp.com",
        databaseURL: "https://chia-tien-57805-default-rtdb.firebaseio.com",
        projectId: "chia-tien-57805",
        storageBucket: "chia-tien-57805.firebasestorage.app",
        messagingSenderId: "204223753606",
        appId: "1:204223753606:web:516c63a18a9d0894779007",
        measurementId: "G-EC2WNHLXF0"
    };
    
    // Khởi tạo ứng dụng Firebase
    firebase.initializeApp(firebaseConfig);

    // Tham chiếu đến node dữ liệu trong Realtime Database
    const dbRef = firebase.database().ref('contributions'); // LƯU Ý: Phải thiết lập RULES cho node 'contributions'

    // 1. Cấu trúc dữ liệu cố định
    const MEMBER_NAMES = ["Duy", "Vanh", "Sơn", "Heo Pepi", "Trung"];
    let contributions = {
        "Duy": 0,
        "Vanh": 0,
        "Sơn": 0,
        "Heo Pepi": 0,
        "Trung": 0,
    };
    
    const K_UNIT = 1000;

    // --- CÁC HÀM XỬ LÝ LƯU TRỮ (FIREBASE) ---

    function saveContributions() {
        // Ghi dữ liệu lên Realtime Database
        dbRef.set(contributions)
            .then(() => {
                console.log("Dữ liệu đã được lưu và đồng bộ lên Firebase.");
            })
            .catch((error) => {
                console.error("Lỗi khi lưu dữ liệu lên Firebase: ", error);
                // Báo lỗi nếu không lưu được
            });
    }

    function loadContributions() {
        // Đọc dữ liệu một lần từ Realtime Database
        dbRef.once('value', (snapshot) => {
            if (snapshot.exists()) {
                const loadedData = snapshot.val();
                console.log("Dữ liệu đã được tải từ Firebase:", loadedData);
                
                // Cập nhật contributions từ dữ liệu tải về
                MEMBER_NAMES.forEach(name => {
                    contributions[name] = loadedData[name] || 0;
                });
            } else {
                // Nếu chưa có dữ liệu trên Firebase, lưu cấu trúc mặc định
                saveContributions();
            }
            // Sau khi tải (hoặc tạo) xong, vẽ bảng
            renderTable();
        }, (error) => {
            console.error("Lỗi khi tải dữ liệu từ Firebase: ", error);
            // Vẫn vẽ bảng với dữ liệu mặc định (toàn 0) nếu có lỗi kết nối
            renderTable(); 
        });
    }

    // --- CÁC HÀM TIỆN ÍCH (Giữ nguyên) ---

    // --- CÁC HÀM TIỆN ÍCH ---

function formatCurrency(amount) {
    // Định dạng số dư thành "+10k" hoặc "-10k" (đơn vị nghìn)
    
    // Nếu số âm, sign là '-'
    // Nếu số dương hoặc bằng 0, sign là '' (rỗng)
    const sign = amount < 0 ? '-' : ''; 
    
    const absAmount = Math.abs(amount / K_UNIT); // Luôn lấy giá trị tuyệt đối
    const formatted = new Intl.NumberFormat('vi-VN').format(Math.round(absAmount));
    
    // Trả về "+0k" nếu gần 0 để chỉ sự cân bằng
    if (Math.abs(amount) < 10) { 
        return '+0k';
    }

    return `${sign}${formatted}k`; 
}

// ... các hàm khác giữ nguyên ...
    function formatTotal(amount) {
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(Math.round(amount));
    }
    
    function formatContributionTotal(amount) {
        return `${new Intl.NumberFormat('vi-VN').format(Math.round(amount / K_UNIT))}k`;
    }

    // --- LOGIC TÍNH TOÁN VÀ CẬP NHẬT ---

    function calculateAndUpdate() {
        const N = MEMBER_NAMES.length;
        
        let totalSpent = 0;
        for (const name in contributions) {
            totalSpent += contributions[name];
            
            const totalElement = document.getElementById(`total-${name.replace(/\s/g, '-')}`);
            if (totalElement) {
                totalElement.textContent = formatContributionTotal(contributions[name]);
            }
        }

        const fairShare = N > 0 ? totalSpent / N : 0;
        
        document.getElementById('totalSpent').textContent = formatTotal(totalSpent);
        document.getElementById('fairShare').textContent = formatTotal(fairShare);

        MEMBER_NAMES.forEach(name => {
            const balance = contributions[name] - fairShare;
            const balanceElement = document.getElementById(`balance-${name.replace(/\s/g, '-')}`);
            
            if (balanceElement) {
                balanceElement.className = 'balance-status';
                if (balance > 10) { 
                    balanceElement.classList.add('positive');
                    balanceElement.textContent = formatCurrency(balance);
                } else if (balance < -10) { 
                    balanceElement.classList.add('negative');
                    balanceElement.textContent = formatCurrency(balance);
                } else {
                    balanceElement.classList.add('neutral');
                    balanceElement.textContent = '+0k'; 
                }
            }
        });
        
        // --- LƯU TRỮ DỮ LIỆU SAU KHI TÍNH TOÁN ---
        saveContributions(); 
    }
    
    // --- CÁC HÀM XỬ LÝ TƯƠNG TÁC (Thêm tiền) ---

    function addContribution(name) {
        const inputElement = document.getElementById(`input-${name.replace(/\s/g, '-')}`);
        const amount = parseFloat(inputElement.value) * K_UNIT || 0;
        
        if (amount > 0) {
            contributions[name] += amount;
            inputElement.value = '';
            calculateAndUpdate();
        } else if (amount < 0) {
             alert("Vui lòng nhập số tiền chi tiêu dương.");
             inputElement.value = '';
        }
    }

    // --- CÁC HÀM XỬ LÝ GIAO DIỆN VÀ KHỞI TẠO ---

    function renderTable() {
        const tbody = document.getElementById('contributionTableBody');
        tbody.innerHTML = '';
        
        MEMBER_NAMES.forEach(name => {
            const row = document.createElement('tr');
            const safeName = name.replace(/\s/g, '-'); 
            
            row.innerHTML = `
                <td>${name}</td>
                <td>
                    <span class="contribution-total" id="total-${safeName}">${formatContributionTotal(contributions[name])}</span>
                </td>
                <td>
                    <div class="add-expense-cell">
                        <input 
                            type="number" 
                            min="0" 
                            id="input-${safeName}"
                            placeholder="Số k"
                            onkeypress="if(event.key === 'Enter') { addContribution('${name}'); }"
                        >
                        <button class="add-button" onclick="addContribution('${name}')">Thêm</button>
                    </div>
                </td>
                <td>
                    <span id="balance-${safeName}" class="balance-status neutral">+0k</span>
                </td>
            `;
            tbody.appendChild(row);
        });
        
        calculateAndUpdate(); 
    }
    
    function resetContributions() {
        if (confirm("Bạn có chắc chắn muốn xóa tất cả số tiền đã đóng góp không? Dữ liệu sẽ bị xóa khỏi tất cả thiết bị.")) {
            MEMBER_NAMES.forEach(name => {
                contributions[name] = 0;
                const inputElement = document.getElementById(`input-${name.replace(/\s/g, '-')}`);
                if (inputElement) {
                    inputElement.value = '';
                }
            });
            
            // Xóa dữ liệu trên Firebase bằng cách ghi lại object contributions rỗng
            dbRef.set(contributions)
                .then(() => {
                    console.log("Dữ liệu đã được xóa khỏi Firebase.");
                    calculateAndUpdate(); // Cập nhật lại giao diện
                })
                .catch((error) => {
                    console.error("Lỗi khi xóa dữ liệu Firebase: ", error);
                    alert("Lỗi: Không thể xóa dữ liệu trên Firebase.");
                });
        }
    }

    // Khởi tạo: Tải dữ liệu từ Firebase khi trang được tải
    document.addEventListener('DOMContentLoaded', loadContributions);
</script>
</body>
</html>
