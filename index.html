<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Chia Tiền</title>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        h2 {
            color: #007bff;
            text-align: center;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }
        th {
            background-color: #007bff;
            color: white;
            font-weight: bold;
        }
        td:nth-child(2) {
            text-align: left;
            font-weight: bold;
        }
        .contribution-cell {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 5px;
        }
        .contribution-total {
            font-size: 1.1em;
            font-weight: bold;
            color: #28a745;
        }
        .clear-button {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            font-size: 0.7em;
            font-weight: bold;
            cursor: pointer;
            padding: 3px 6px;
            transition: background-color 0.2s;
            line-height: 1;
        }
        .clear-button:hover {
            background-color: #f5c6cb;
        }
        .add-expense-cell {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        .add-expense-cell input[type="number"] {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: right;
            width: 60px;
        }
        .add-button {
            padding: 8px 12px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .add-button:hover {
            background-color: #1e7e34;
        }
        .summary {
            margin-top: 20px;
            padding: 15px;
            background-color: #e9f7ff;
            border-radius: 6px;
            border-left: 5px solid #007bff;
        }
        .positive {
            color: #28a745;
            font-weight: bold;
        }
        .negative {
            color: #dc3545;
            font-weight: bold;
        }
        .neutral {
            color: #6c757d;
            font-weight: bold;
        }
        .reset-button {
            margin-top: 15px;
            padding: 10px 15px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            width: 100%;
        }
        .reset-button:hover {
            background-color: #c82333;
        }
        .participation-checkbox {
            transform: scale(1.5);
        }

        /* Responsive small screens */
        @media (max-width: 480px) {
            .container { padding: 10px; }
            th, td { padding: 8px; font-size: 14px; }
            .add-expense-cell input[type="number"] { width: 50px; }
        }
    </style>
</head>
<body>

<div class="container">
    <h2>Nhập Tiền Vào Để Tính</h2>

    <div class="summary">
        <p><strong>Tổng Chi Tiêu:</strong> <span id="totalSpent">0 VNĐ</span></p>
        <p><strong>Chia Đều:</strong> <span id="fairShare">0 VNĐ</span></p>
    </div>

    <table>
        <thead>
            <tr>
                <th>Tham gia</th>
                <th>Tên</th>
                <th>Tiền Ae Mua</th>
                <th>Nhập tiền vào</th>
                <th>Sau Tính Toán</th>
            </tr>
        </thead>
        <tbody id="contributionTableBody">
        </tbody>
    </table>

    <button class="reset-button" onclick="resetContributions()">Xóa tất cả dữ liệu đã nhập</button>
</div>

<script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyAmoKeG8CUMldomehgVG_hGA8Gn7mb2iwA",
        authDomain: "chia-tien-57805.firebaseapp.com",
        databaseURL: "https://chia-tien-57805-default-rtdb.firebaseio.com",
        projectId: "chia-tien-57805",
        storageBucket: "chia-tien-57805.firebasestorage.app",
        messagingSenderId: "204223753606",
        appId: "1:204223753606:web:516c63a18a9d0894779007",
        measurementId: "G-EC2WNHLXF0"
    };

    firebase.initializeApp(firebaseConfig);
    const dbRef = firebase.database().ref('chia-tien-app'); // node chính

    // --- DỮ LIỆU BAN ĐẦU ---
    const MEMBER_NAMES = ["Duy", "Vanh", "Sơn", "Heo Pepi", "Trung"];
    const K_UNIT = 1000;

    // contributions và participation sẽ được tính từ transactions
    let contributions = {};   // tổng các khoản mỗi người đã trả (tính từ transactions)
    let mustPay = {};         // tổng mỗi người phải trả (tính từ transactions)
    let participation = {};   // checkbox hiện trạng (dùng để chọn participant cho transaction mới)
    let transactions = [];    // mảng transaction: { payer, amount, participants: [...] }

    // init structure
    MEMBER_NAMES.forEach(n => {
        contributions[n] = 0;
        mustPay[n] = 0;
        participation[n] = true;
    });

    // --- HỖ TRỢ HIỂN THỊ ---
    function formatCurrency(amount) {
        // amount in VND (số thực) -> hiển thị xk
        const sign = amount < 0 ? '-' : '';
        const absAmount = Math.abs(amount / K_UNIT);
        const formatted = new Intl.NumberFormat('vi-VN').format(Math.round(absAmount));
        if (Math.abs(amount) < 10) return '+0k';
        return `${sign}${formatted}k`;
    }

    function formatTotal(amount) {
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(Math.round(amount));
    }

    function formatContributionTotal(amount) {
        return `${new Intl.NumberFormat('vi-VN').format(Math.round(amount / K_UNIT))}k`;
    }

    // --- LƯU / TẢI DỮ LIỆU (vào firebase) ---
    function saveData() {
        const dataToSave = {
            participation: participation,
            transactions: transactions
        };
        return dbRef.set(dataToSave);
    }

    function loadData() {
        dbRef.once('value', snapshot => {
            if (snapshot.exists()) {
                const data = snapshot.val();
                participation = data.participation || participation;
                transactions = data.transactions || [];
            } else {
                // lần đầu: lưu cấu trúc mặc định
                saveData();
            }
            // đảm bảo có key cho tất cả member
            MEMBER_NAMES.forEach(n => {
                if (participation[n] === undefined) participation[n] = true;
            });

            renderTable();
            calculateAndUpdate(false);
        }, error => {
            console.error("Lỗi khi tải dữ liệu từ Firebase: ", error);
            renderTable();
            calculateAndUpdate(false);
        });
    }

    // --- XỬ LÝ TRANSACTIONS & TÍNH TOÁN ---
    function recalcFromTransactions() {
        // reset
        MEMBER_NAMES.forEach(n => {
            contributions[n] = 0;
            mustPay[n] = 0;
        });

        // contributions: tổng do mỗi payer trả
        transactions.forEach(t => {
            if (!contributions[t.payer]) contributions[t.payer] = 0;
            contributions[t.payer] += t.amount;
        });

        // mustPay: mỗi transaction chia đều theo participants
        transactions.forEach(t => {
            const partCount = (t.participants && t.participants.length) || 0;
            if (partCount === 0) return;
            const split = t.amount / partCount;
            t.participants.forEach(p => {
                if (!mustPay[p]) mustPay[p] = 0;
                mustPay[p] += split;
            });
        });
    }

    function calculateAndUpdate(shouldRenderTable = true) {
        // tính lại từ transactions
        recalcFromTransactions();

        // tổng chi tiêu
        let totalSpent = transactions.reduce((s, t) => s + (t.amount || 0), 0);

        // fairShare: giữ là trung bình trên tất cả thành viên (chỉ để hiển thị)
        const fairShare = MEMBER_NAMES.length > 0 ? totalSpent / MEMBER_NAMES.length : 0;

        document.getElementById('totalSpent').textContent = formatTotal(totalSpent);
        document.getElementById('fairShare').textContent = formatTotal(fairShare);

        // cập nhật ô tổng đã đóng (contribution) và balance (đã đóng - phải trả)
        MEMBER_NAMES.forEach(name => {
            const safeName = name.replace(/\s/g, '-');
            const totalEl = document.getElementById(`total-${safeName}`);
            if (totalEl) totalEl.textContent = formatContributionTotal(contributions[name] || 0);

            const balEl = document.getElementById(`balance-${safeName}`);
            if (!balEl) return;
            balEl.className = 'balance-status';
            const bal = (contributions[name] || 0) - (mustPay[name] || 0);

            if (Math.abs(bal) < 10) {
                balEl.classList.add('neutral');
                balEl.textContent = '+0k';
            } else if (bal > 0) {
                balEl.classList.add('positive');
                balEl.textContent = formatCurrency(bal);
            } else {
                balEl.classList.add('negative');
                balEl.textContent = formatCurrency(bal);
            }
        });

        // lưu data
        saveData().catch(err => console.error("Lỗi saveData:", err));

        if (shouldRenderTable) renderTable();
    }

    // --- XÓA SỐ TIỀN ĐÓNG CỦA 1 NGƯỜI (bằng cách xóa transactions họ là payer) ---
    function clearContribution(name) {
        if (!confirm(`Bạn có chắc chắn muốn xóa tất cả giao dịch do ${name} trả không?`)) return;
        // loại bỏ tất cả transaction có payer = name
        transactions = transactions.filter(t => t.payer !== name);
        calculateAndUpdate(true);
    }

    // --- TOGGLE participation (chỉ ảnh hưởng tới lần nhập tiếp theo) ---
    function toggleParticipation(name) {
        const checkbox = document.getElementById(`participate-${name.replace(/\s/g, '-')}`);
        participation[name] = checkbox.checked;
        // không cần render table toàn bộ, chỉ lưu trạng thái checkbox
        saveData().catch(err => console.error("Lỗi save participation:", err));
    }

    // --- THÊM TRANSACTION --- 
    function addContribution(name) {
        const inputElement = document.getElementById(`input-${name.replace(/\s/g, '-')}`);
        const raw = parseFloat(inputElement.value);
        const amount = (!isNaN(raw) ? raw : 0) * K_UNIT;

        if (amount <= 0) {
            alert("Vui lòng nhập số tiền dương (đơn vị k).");
            inputElement.value = '';
            return;
        }

        // lấy danh sách người đang được tick tại thời điểm bấm thêm
        const currentParticipants = MEMBER_NAMES.filter(n => {
            const cb = document.getElementById(`participate-${n.replace(/\s/g, '-')}`);
            return cb && cb.checked;
        });

        if (currentParticipants.length === 0) {
            alert("Chưa chọn ai để chia tiền! Vui lòng đánh dấu người tham gia trước khi thêm.");
            return;
        }

        // tạo transaction
        const tx = {
            payer: name,
            amount: amount,
            participants: currentParticipants
        };
        transactions.push(tx);

        inputElement.value = '';
        calculateAndUpdate(true);
    }

    // --- VẼ BẢNG (render) ---
    function renderTable() {
        const tbody = document.getElementById('contributionTableBody');

        // nếu chưa có hàng thì tạo; nếu đã có đủ hàng (số member) chỉ cập nhật nút/txt
        if (tbody.children.length === MEMBER_NAMES.length) {
            // cập nhật các ô
            MEMBER_NAMES.forEach(name => {
                const safe = name.replace(/\s/g, '-');
                // update total và balance và checkbox trạng thái
                const totalEl = document.getElementById(`total-${safe}`);
                if (totalEl) totalEl.textContent = formatContributionTotal(contributions[name] || 0);

                const balEl = document.getElementById(`balance-${safe}`);
                if (balEl) {
                    const bal = (contributions[name] || 0) - (mustPay[name] || 0);
                    balEl.className = 'balance-status';
                    if (Math.abs(bal) < 10) {
                        balEl.classList.add('neutral'); balEl.textContent = '+0k';
                    } else if (bal > 0) {
                        balEl.classList.add('positive'); balEl.textContent = formatCurrency(bal);
                    } else {
                        balEl.classList.add('negative'); balEl.textContent = formatCurrency(bal);
                    }
                }

                const cb = document.getElementById(`participate-${safe}`);
                if (cb) cb.checked = participation[name];
            });
            return;
        }

        // lần đầu vẽ
        tbody.innerHTML = '';
        MEMBER_NAMES.forEach(name => {
            const safeName = name.replace(/\s/g, '-');
            const row = document.createElement('tr');

            row.innerHTML = `
                <td>
                    <input 
                        type="checkbox" 
                        class="participation-checkbox"
                        id="participate-${safeName}"
                        ${participation[name] ? 'checked' : ''}
                        onchange="toggleParticipation('${name}')"
                    >
                </td>
                <td>${name}</td>
                <td>
                    <div class="contribution-cell">
                        <span class="contribution-total" id="total-${safeName}">${formatContributionTotal(contributions[name] || 0)}</span>
                        <button class="clear-button" onclick="clearContribution('${name}')">Xóa</button>
                    </div>
                </td>
                <td>
                    <div class="add-expense-cell">
                        <input 
                            type="number" 
                            min="0" 
                            id="input-${safeName}"
                            placeholder="Số k"
                            onkeypress="if(event.key === 'Enter') { addContribution('${name}'); }"
                        >
                        <button class="add-button" onclick="addContribution('${name}')">Thêm</button>
                    </div>
                </td>
                <td>
                    <span id="balance-${safeName}" class="balance-status neutral">+0k</span>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    // --- XÓA TẤT CẢ (reset) ---
    function resetContributions() {
        if (!confirm("Bạn có chắc chắn muốn xóa tất cả số tiền đã đóng góp không? Dữ liệu sẽ bị xóa khỏi tất cả thiết bị.")) return;

        // reset local structures
        transactions = [];
        MEMBER_NAMES.forEach(name => {
            contributions[name] = 0;
            mustPay[name] = 0;
            participation[name] = true;
            const inputElement = document.getElementById(`input-${name.replace(/\s/g, '-')}`);
            if (inputElement) inputElement.value = '';
        });

        // lưu vào firebase
        saveData()
            .then(() => {
                calculateAndUpdate(true);
            })
            .catch(err => {
                console.error("Lỗi khi xóa dữ liệu Firebase: ", err);
                alert("Lỗi: Không thể xóa dữ liệu trên Firebase.");
            });
    }

    // --- Khởi tạo ---
    document.addEventListener('DOMContentLoaded', () => {
        renderTable();
        loadData();
    });
</script>
</body>
</html>

