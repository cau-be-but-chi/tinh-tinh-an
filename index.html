<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chia Tiền</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        h2 {
            color: #007bff;
            text-align: center;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }
        th {
            background-color: #007bff;
            color: white;
            font-weight: bold;
        }
        td:nth-child(2) { 
            text-align: left;
            font-weight: bold;
        }
        .contribution-cell {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 5px; 
        }
        .contribution-total {
            font-size: 1.1em;
            font-weight: bold;
            color: #28a745;
        }
        .clear-button { 
            background-color: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            font-size: 0.7em;
            font-weight: bold;
            cursor: pointer;
            padding: 3px 6px;
            transition: background-color 0.2s;
            line-height: 1;
        }
        .clear-button:hover {
            background-color: #f5c6cb;
        }
        .add-expense-cell {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        .add-expense-cell input[type="number"] {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: right;
            width: 60px;
        }
        .add-button {
            padding: 8px 12px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .add-button:hover {
            background-color: #1e7e34;
        }
        .summary {
            margin-top: 20px;
            padding: 15px;
            background-color: #e9f7ff;
            border-radius: 6px;
            border-left: 5px solid #007bff;
        }
        .positive {
            color: #28a745;
            font-weight: bold;
        }
        .negative {
            color: #dc3545;
            font-weight: bold;
        }
        .neutral {
            color: #6c757d;
            font-weight: bold;
        }
        .reset-button {
            margin-top: 15px;
            padding: 10px 15px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            width: 100%;
        }
        .reset-button:hover {
            background-color: #c82333;
        }
        .participation-checkbox {
            transform: scale(1.5);
        }
    </style>
</head>
<body>

<div class="container">
    <h2>Nhập Tiền Vào Để Tính</h2>
    
    <div class="summary">
        <p><strong>Tổng Chi Tiêu:</strong> <span id="totalSpent">0 VNĐ</span></p>
        <p><strong>Chia Đều:</strong> <span id="fairShare">0 VNĐ</span></p>
    </div>

    <table>
        <thead>
            <tr>
                <th>Tham gia</th>
                <th>Tên</th>
                <th>Tiền Ae Mua</th>
                <th>Nhập tiền vào</th>
                <th>Sau Tính Toán</th>
            </tr>
        </thead>
        <tbody id="contributionTableBody">
            </tbody>
    </table>
    
    <button class="reset-button" onclick="resetContributions()">Xóa tất cả dữ liệu đã nhập</button>
</div>

<script>
    // --- KHỞI TẠO FIREBASE (Sử dụng cấu hình của bạn) ---
    const firebaseConfig = {
        apiKey: "AIzaSyAmoKeG8CUMldomehgVG_hGA8Gn7mb2iwA",
        authDomain: "chia-tien-57805.firebaseapp.com",
        databaseURL: "https://chia-tien-57805-default-rtdb.firebaseio.com",
        projectId: "chia-tien-57805",
        storageBucket: "chia-tien-57805.firebasestorage.app",
        messagingSenderId: "204223753606",
        appId: "1:204223753606:web:516c63a18a9d0894779007",
        measurementId: "G-EC2WNHLXF0"
    };
    
    firebase.initializeApp(firebaseConfig);
    const dbRef = firebase.database().ref('contributions'); 

    // 1. Cấu trúc dữ liệu cố định
    const MEMBER_NAMES = ["Duy", "Vanh", "Sơn", "Heo Pepi", "Trung"];
    let contributions = {
        "Duy": 0,
        "Vanh": 0,
        "Sơn": 0,
        "Heo Pepi": 0,
        "Trung": 0,
    };
    
    let participation = {
        "Duy": true,
        "Vanh": true,
        "Sơn": true,
        "Heo Pepi": true,
        "Trung": true,
    };

    const K_UNIT = 1000;

    // --- CÁC HÀM TIỆN ÍCH ---

    function formatCurrency(amount) {
        const sign = amount < 0 ? '-' : ''; 
        const absAmount = Math.abs(amount / K_UNIT);
        const formatted = new Intl.NumberFormat('vi-VN').format(Math.round(absAmount));
        
        if (Math.abs(amount) < 10) { 
            return '+0k';
        }
        return `${sign}${formatted}k`; 
    }
    
    function formatTotal(amount) {
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(Math.round(amount));
    }
    
    function formatContributionTotal(amount) {
        return `${new Intl.NumberFormat('vi-VN').format(Math.round(amount / K_UNIT))}k`;
    }

    // --- CÁC HÀM XỬ LÝ LƯU TRỮ (FIREBASE) ---

    function saveContributions() {
        const dataToSave = {
            contributions: contributions,
            participation: participation 
        };
        dbRef.set(dataToSave); 
    }

    function loadContributions() {
        dbRef.once('value', (snapshot) => {
            if (snapshot.exists()) {
                const loadedData = snapshot.val();
                
                const loadedContributions = loadedData.contributions || {};
                MEMBER_NAMES.forEach(name => {
                    contributions[name] = loadedContributions[name] || 0;
                });
                
                const loadedParticipation = loadedData.participation || {};
                MEMBER_NAMES.forEach(name => {
                    participation[name] = loadedParticipation[name] !== undefined ? loadedParticipation[name] : true;
                });

            } else {
                saveContributions(); 
            }
            
            renderTable(); // Gọi renderTable LẦN ĐẦU
            calculateAndUpdate(false); // Tính toán mà không gọi lại renderTable
        }, (error) => {
            console.error("Lỗi khi tải dữ liệu từ Firebase: ", error);
            renderTable(); 
            calculateAndUpdate(false);
        });
    }

    // --- LOGIC TÍNH TOÁN VÀ CẬP NHẬT (Đã sửa lỗi) ---
    function calculateAndUpdate(shouldRenderTable = true) {
        let N = 0;
        MEMBER_NAMES.forEach(name => {
            if (participation[name]) {
                N++;
            }
        });

        let totalSpent = 0;
        for (const name in contributions) {
            totalSpent += contributions[name];
            
            // CẬP NHẬT TRỰC TIẾP Ô TIỀN ĐÓNG (FIX LỖI)
            const totalElement = document.getElementById(`total-${name.replace(/\s/g, '-')}`);
            if (totalElement) {
                totalElement.textContent = formatContributionTotal(contributions[name]);
            }
        }

        const fairShare = N > 0 ? totalSpent / N : 0;
        
        document.getElementById('totalSpent').textContent = formatTotal(totalSpent);
        document.getElementById('fairShare').textContent = formatTotal(fairShare);

        MEMBER_NAMES.forEach(name => {
            const balanceElement = document.getElementById(`balance-${name.replace(/\s/g, '-')}`);
            
            if (balanceElement) {
                balanceElement.className = 'balance-status';
                
                if (participation[name]) {
                    const balance = contributions[name] - fairShare;

                    if (totalSpent > 0 && balance > 10) { 
                        balanceElement.classList.add('positive'); 
                        balanceElement.textContent = formatCurrency(balance);
                    } else if (totalSpent > 0 && balance < -10) { 
                        balanceElement.classList.add('negative'); 
                        balanceElement.textContent = formatCurrency(balance);
                    } else {
                        balanceElement.classList.add('neutral'); 
                        balanceElement.textContent = '+0k'; 
                    }
                } else {
                    // Nếu không tham gia, chỉ hiển thị số tiền đã đóng
                    balanceElement.classList.add('neutral'); 
                    balanceElement.textContent = formatContributionTotal(contributions[name]); 
                    if (contributions[name] === 0) {
                        balanceElement.textContent = '-'; 
                    }
                }
            }
        });
        
        saveContributions(); 
        
        // Chỉ gọi renderTable nếu cần thiết (ví dụ: sau khi xóa cục bộ)
        if (shouldRenderTable) {
            renderTable();
        }
    }
    
    // --- HÀM XÓA TIỀN ĐÓNG CỦA MỘT NGƯỜI ---
    function clearContribution(name) {
        if (confirm(`Bạn có chắc chắn muốn xóa số tiền đóng góp của ${name} (${formatContributionTotal(contributions[name])}) không?`)) {
            contributions[name] = 0; 
            
            const inputElement = document.getElementById(`input-${name.replace(/\s/g, '-')}`);
            if (inputElement) {
                inputElement.value = '';
            }
            
            // Gọi calculateAndUpdate với true để cập nhật nút Xóa trên giao diện
            calculateAndUpdate(true); 
        }
    }

    // --- HÀM XỬ LÝ SỰ KIỆN THAY ĐỔI CHECKBOX ---
    function toggleParticipation(name) {
        const checkbox = document.getElementById(`participate-${name.replace(/\s/g, '-')}`);
        participation[name] = checkbox.checked; 
        calculateAndUpdate(false); // Không cần vẽ lại bảng khi tích/bỏ tích
    }

    // --- CÁC HÀM XỬ LÝ TƯƠNG TÁC (Thêm tiền) ---

    function addContribution(name) {
        const inputElement = document.getElementById(`input-${name.replace(/\s/g, '-')}`);
        const amount = parseFloat(inputElement.value) * K_UNIT || 0;
        
        if (amount > 0) {
            contributions[name] += amount;
            inputElement.value = '';
            calculateAndUpdate(true); // Cần vẽ lại để cập nhật nút Xóa/Tiền Đóng
        } else if (amount < 0) {
             alert("Vui lòng nhập số tiền chi tiêu dương.");
             inputElement.value = '';
        }
    }

    // --- CÁC HÀM XỬ LÝ GIAO DIỆN VÀ KHỞI TẠO ---
    // HÀM NÀY CHỈ DÙNG ĐỂ VẼ CẤU TRÚC LẦN ĐẦU VÀ CẬP NHẬT NÚT XÓA

    function renderTable() {
        const tbody = document.getElementById('contributionTableBody');
        // Nếu đã có cấu trúc, không vẽ lại (tránh lỗi)
        if (tbody.children.length === MEMBER_NAMES.length) {
            // Cập nhật lại HTML của ô Tiền Đóng để cập nhật nút Xóa
            MEMBER_NAMES.forEach(name => {
                const safeName = name.replace(/\s/g, '-');
                const cell = document.querySelector(`#total-${safeName}`).closest('td');
                
                if (cell) {
                    cell.innerHTML = `
                        <div class="contribution-cell">
                            <span class="contribution-total" id="total-${safeName}">${formatContributionTotal(contributions[name])}</span>
                            <button class="clear-button" onclick="clearContribution('${name}')">Xóa</button>
                        </div>
                    `;
                }
            });
            return;
        }

        // VẼ CẤU TRÚC LẦN ĐẦU
        tbody.innerHTML = '';
        
        MEMBER_NAMES.forEach(name => {
            const row = document.createElement('tr');
            const safeName = name.replace(/\s/g, '-'); 
            
            row.innerHTML = `
                <td>
                    <input 
                        type="checkbox" 
                        class="participation-checkbox"
                        id="participate-${safeName}" 
                        ${participation[name] ? 'checked' : ''}
                        onchange="toggleParticipation('${name}')"
                    >
                </td>
                <td>${name}</td>
                <td>
                    <div class="contribution-cell">
                        <span class="contribution-total" id="total-${safeName}">${formatContributionTotal(contributions[name])}</span>
                        <button class="clear-button" onclick="clearContribution('${name}')">Xóa</button>
                    </div>
                </td>
                <td>
                    <div class="add-expense-cell">
                        <input 
                            type="number" 
                            min="0" 
                            id="input-${safeName}"
                            placeholder="Số k"
                            onkeypress="if(event.key === 'Enter') { addContribution('${name}'); }"
                        >
                        <button class="add-button" onclick="addContribution('${name}')">Thêm</button>
                    </div>
                </td>
                <td>
                    <span id="balance-${safeName}" class="balance-status neutral">+0k</span>
                </td>
            `;
            tbody.appendChild(row);
        });
    }
    
    function resetContributions() {
        if (confirm("Bạn có chắc chắn muốn xóa tất cả số tiền đã đóng góp không? Dữ liệu sẽ bị xóa khỏi tất cả thiết bị.")) {
            MEMBER_NAMES.forEach(name => {
                contributions[name] = 0;
                participation[name] = true; 
                const inputElement = document.getElementById(`input-${name.replace(/\s/g, '-')}`);
                if (inputElement) {
                    inputElement.value = '';
                }
            });
            
            dbRef.set({
                contributions: contributions,
                participation: participation
            })
                .then(() => {
                    calculateAndUpdate(true); // Tính toán và gọi renderTable
                })
                .catch((error) => {
                    console.error("Lỗi khi xóa dữ liệu Firebase: ", error);
                    alert("Lỗi: Không thể xóa dữ liệu trên Firebase.");
                });
        }
    }

    document.addEventListener('DOMContentLoaded', loadContributions);
</script>
</body>
</html>

